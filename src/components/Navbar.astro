---
import navigation from '../settings/navigation.json';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const pages = await getCollection('page');
const existingSlugs = new Set(pages.map(p => {
    let s = p.id;
    if (!s.startsWith('/')) s = '/' + s;
    return s.replace(/\/+$/, '') || '/';
}));

// Check for physical .astro files in src/pages
const pagesDir = path.resolve('./src/pages');
function getPhysicalPages(dir: string, prefix = ''): string[] {
    let results: string[] = [];
    if (!fs.existsSync(dir)) return results;
    const list = fs.readdirSync(dir);
    list.forEach(file => {
        const fullPath = path.join(dir, file);
        const stat = fs.statSync(fullPath);
        if (stat && stat.isDirectory()) {
            results = results.concat(getPhysicalPages(fullPath, prefix + file + '/'));
        } else if (file.endsWith('.astro') && !file.startsWith('[') && !file.startsWith('_')) {
            let slug = prefix + file.replace('.astro', '');
            if (slug === 'index') slug = '';
            results.push('/' + slug.replace(/\/+$/, ''));
        }
    });
    return results;
}
const physicalPages = getPhysicalPages(pagesDir);
physicalPages.forEach(p => existingSlugs.add(p || '/'));

function hrefExists(href: string) {
    if (href.startsWith('http')) return true;
    let norm = decodeURIComponent(href).replace(/\/+$/, '') || '/';
    return existingSlugs.has(norm);
}

// Ensure we have a clean list of links with optional sublinks
type NavLink = {
    label: string;
    title: string,
    href: string;
    show_in_header: boolean;
    sublinks?: Array<{ label: string; title: string, href: string, show_in_header: boolean }> | null
};
const links: Array<NavLink> = Array.isArray(navigation?.links)
    ? navigation.links
        .filter((l: any) => l && typeof l.label === 'string' && typeof l.href === 'string' && hrefExists(l.href))
        .map((l: any) => ({
            label: l.label,
            title: l.title,
            href: l.href,
            show_in_header: l.show_in_header,
            sublinks: Array.isArray(l?.sublinks)
                ? l.sublinks.filter((s: any) => s && typeof s.label === 'string' && typeof s.href === 'string' && hrefExists(s.href))
                : undefined,
        }))
    : [];

const currentPath = Astro.url.pathname;
const normalize = (path: string) => decodeURIComponent(path).replace(/\/$/, '') || '/';
const normalizedCurrentPath = normalize(currentPath);
---
<nav class="mod_navigation nav_main block" role="navigation">
  <a href="#main" class="invisible">Navigation Ã¼berspringen</a>
  <ul class="level_1">
      {
          links.filter((l) => {
              return l.show_in_header;
          }).map((l) => {
              const isActive = normalize(l.href) === normalizedCurrentPath;
              const isSubActive = l.sublinks?.some(s => normalize(s.href) === normalizedCurrentPath);
              return (
                <li class="submenu">
                    {isActive ?
                        (<span class={isActive ? 'active' : ''}>{l.label}</span>)
                        : (<a href={l.href} title={l.title} class={isSubActive ? 'trail' : ''} target={l.href.startsWith('http') ? '_blank' : undefined} rel={l.href.startsWith('http') ? 'noopener noreferrer' : undefined}>{l.label}</a>)
                    }
                    {Array.isArray(l.sublinks) && l.sublinks.length > 0 ? (
                      <ul class="level_2">
                          {l.sublinks.filter((l) => {
                              return l.show_in_header;
                          }).map((s) => {
                              const isSubActive = normalize(s.href) === normalizedCurrentPath;
                              return (
                                <li>
                                    {isSubActive ?
                                        (<span class={isSubActive ? 'active' : ''}>{s.label}</span>)
                                        : (<a href={s.href} title={s.title} target={s.href.startsWith('http') ? '_blank' : undefined} rel={s.href.startsWith('http') ? 'noopener noreferrer' : undefined}>{s.label}</a>)
                                    }
                                </li>
                              );
                          })}
                      </ul>
                    ) : null}
                </li>
              );
          })
      }
  </ul>
</nav>